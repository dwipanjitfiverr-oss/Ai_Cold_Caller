//@version=5
// BTCUSD Smart ML-Based Indicator V2
// Enhanced with trend filter + improved parameters

strategy("BTCUSD Smart Entry V2", overlay=true, default_qty_type=strategy.percent_of_equity, default_qty_value=10)

// === INPUTS ===
src = input(close, title="Source")
emaLen = input.int(200, title="Trend EMA")
rsiLen = input.int(14, title="RSI")
stochLen = input.int(14, title="Stochastic")
rsiOB = input.float(68, title="RSI Overbought")
rsiOS = input.float(32, title="RSI Oversold")
stochOB = input.float(75, title="Stochastic Overbought")
stochOS = input.float(25, title="Stochastic Oversold")
useTrailing = input(true, title="Trailing Stop")
tsPercent = input.float(3.0, title="Trailing Stop %")
profitTarget = input.float(5.0, title="Profit Target %")

// === INDICATORS ===
ema200 = ta.ema(src, ema200)
rsi = ta.rsi(src, rsiLen)
stochK = ta.stoch(src, high, low, stochLen)
stochD = ta.sma(stochK, 3)

// === TREND FILTER ===
trendUp = src > ema200

// === SIGNALS ===
buySignal = trendUp and rsi < rsiOS and stochK < stochOS
sellSignal = rsi > rsiOB or stochK > stochOB

// === PLOTTING ===
plot(ema200, color=color.red, title="200 EMA", linewidth=2)

plotshape(buySignal, title="BUY", location=location.belowbar, 
     color=color.lime, style=shape.labelup, text="BUY\n(RSI:" + str.tostring(rsi, "#") + ")")

plotshape(sellSignal, title="SELL", location=location.abovebar, 
     color=color.red, style=shape.labeldown, text="SELL")

// RSI Plot
rsiPlot = plot(rsi, title="RSI", color=color.purple, linewidth=2)
plot(rsiOB, color=color.red, linestyle=plot.style_line)
plot(rsiOS, color=color.lime, linestyle=plot.style_line)
fill(rsiPlot, plot(rsiOB), color=color.new(color.red, 90))
fill(rsiPlot, plot(rsiOS), color=color.new(color.lime, 90))

// === STRATEGY ===
if (buySignal)
    strategy.entry("Long", strategy.long)

if (sellSignal)
    strategy.close("Long")

// Profit target
strategy.exit("ProfitTarget", from_entry="Long", qty_percent=50, limit=strategy.position_avg_price * (1 + profitTarget/100))

// Trailing stop
if (useTrailing)
    strategy.exit("TS", from_entry="Long", trail_percent=tsPercent)

// === ALERTS ===
alertcondition(buySignal, title="Buy Alert", message="BTCUSD BUY - RSI:{{rsi}} Stoch:{{stochK}}")
alertcondition(sellSignal, title="Sell Alert", message="BTCUSD SELL - RSI:{{rsi}} Stoch:{{stochK}}")

// === INFO ===
var label lbl = label.new(bar_index, high, "RSI: " + str.tostring(rsi, "#.0"), 
     color=color.new(color.blue, 80), textcolor=color.white, size=size.tiny, style=label.style_label_upper)
label.set_x(lbl, bar_index)
